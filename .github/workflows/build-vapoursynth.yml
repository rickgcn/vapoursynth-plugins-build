name: Build VapourSynth

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'VapourSynth version to build (e.g., R70)'
        required: false
        default: 'R70'

jobs:
  build-linux:
    name: Build VapourSynth - Linux glibc
    runs-on: ubuntu-24.04
    steps:
      - name: Install build dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: build-essential python3-dev python3-pip cython3 autoconf automake libtool pkg-config nasm git
          version: 1.0

      - name: Download VapourSynth
        run: |
          git clone https://github.com/vapoursynth/vapoursynth.git
          cd vapoursynth
          git checkout ${{ github.event.inputs.version }}

      - name: Build and install zimg
        run: |
          git clone https://github.com/sekrit-twc/zimg.git --recursive
          cd zimg
          ./autogen.sh
          ./configure --prefix=/usr/local CFLAGS="-O3 -fPIC" CXXFLAGS="-O3 -fPIC"
          make -j$(nproc)
          sudo make install
          make install DESTDIR=$HOME/destdir
          sudo ldconfig

      - name: Build VapourSynth
        run: |
          cd vapoursynth

          ./autogen.sh
          ./configure \
            --prefix=/usr/local \
            CFLAGS="-O3 -fPIC" \
            CXXFLAGS="-O3 -fPIC"

          make -j$(nproc)
          make install DESTDIR=$HOME/destdir

      - name: Package VapourSynth
        run: |
          cd $HOME/destdir/usr/local
          tar czf $HOME/destdir/vapoursynth-${{ github.event.inputs.version }}-linux-glibc.tar.gz .

          # Generate metadata
          cd $HOME/destdir
          cat > vapoursynth-info.txt <<EOF
          VapourSynth Version: ${{ github.event.inputs.version }}
          Platform: Linux x86_64
          C Library: glibc (dynamic linking)
          Dependencies: zimg (bundled)
          Built on: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Commit: ${{ github.sha }}
          EOF

          ls -lh vapoursynth-*.tar.gz

      - name: Upload VapourSynth artifact
        uses: actions/upload-artifact@v4
        with:
          name: vapoursynth-${{ github.event.inputs.version }}-linux-glibc
          path: |
            ~/destdir/vapoursynth-*.tar.gz
            ~/destdir/vapoursynth-info.txt
          retention-days: 90

  create-release:
    name: Create VapourSynth Release
    needs: build-linux
    if: needs.build-linux.result == 'success'
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Download all VapourSynth artifacts
        uses: actions/download-artifact@v4
        with:
          path: vapoursynth-builds

      - name: Create release tag
        id: tag
        run: |
          TAG_NAME="vapoursynth-${{ github.event.inputs.version }}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Check if release exists
        id: check-release
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/${{ steps.tag.outputs.tag_name }}$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare release files
        if: steps.check-release.outputs.exists == 'false'
        run: |
          mkdir -p release-files

          # Copy all archives
          find vapoursynth-builds -name "*.tar.gz" -exec cp {} release-files/ \;

          # Create README
          cat > release-files/README.md <<'EOF'
          # VapourSynth ${{ github.event.inputs.version }}

          Pre-built VapourSynth binaries for Linux (glibc, dynamic linking).

          ## Build Information

          EOF

          find vapoursynth-builds -name "vapoursynth-info.txt" -exec cat {} \; >> release-files/README.md

          cat >> release-files/README.md <<'EOF'

          ## Installation

          ### Extract to system
          ```bash
          sudo tar xzf vapoursynth-*-linux-glibc.tar.gz -C /usr/local
          sudo ldconfig
          ```

          ### Extract to custom location
          ```bash
          mkdir -p $HOME/vapoursynth
          tar xzf vapoursynth-*-linux-glibc.tar.gz -C $HOME/vapoursynth
          export PATH="$HOME/vapoursynth/bin:$PATH"
          export LD_LIBRARY_PATH="$HOME/vapoursynth/lib:$LD_LIBRARY_PATH"
          export PYTHONPATH="$HOME/vapoursynth/lib/python3/site-packages:$PYTHONPATH"
          ```

          ## Usage

          Test VapourSynth installation:
          ```bash
          vspipe --version
          python3 -c "import vapoursynth; print(vapoursynth.core.version())"
          ```

          ## Notes

          This is a dynamically linked glibc build. For cross-compilation to older systems,
          use the provided crosstool-NG toolchains (glibc 2.17, kernel 3.2.101+).
          EOF

          ls -lh release-files/

      - name: Create GitHub Release
        if: steps.check-release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: VapourSynth ${{ github.event.inputs.version }}
          body_path: release-files/README.md
          draft: false
          prerelease: false
          files: release-files/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release already exists
        if: steps.check-release.outputs.exists == 'true'
        run: |
          echo "::notice::Release ${{ steps.tag.outputs.tag_name }} already exists, skipping creation"
